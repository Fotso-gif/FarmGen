{% extends 'account/layout/base_dashboard.html' %}
{% load static %}

{% block content %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .btn-outline-primary{
        color: var(--primary);
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        text-align: center;
        position: relative;
        transition: transform 0.2s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
    }
    
    .stat-card.primary { border-top: 4px solid var(--primary); }
    .stat-card.success { border-top: 4px solid var(--success); }
    .stat-card.warning { border-top: 4px solid var(--warning); }
    .stat-card.info { border-top: 4px solid var(--accent); }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 10px 0;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin: 25px 0;
    }
    
    .action-btn {
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        padding: 15px;
        border-radius: var(--radius);
        text-align: center;
        text-decoration: none;
        transition: var(--transition);
        cursor: pointer;
    }
    
    .action-btn:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }
    
    .payment-methods {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        justify-content: flex-end;
    }
    
    .payment-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        font-size: 14px;
        color: #6c757d;
    }
    
    .payment-icon.active {
        background: var(--success);
        color: white;
        border-color: var(--success);
    }
    
    .order-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 15px;
        align-items: center;
        background: white;
        padding: 15px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 10px;
    }
    
    .shop-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    
    .shop-info {
        flex: 1;
    }
    
    .shop-status {
        text-align: right;
    }
    
    .product-image {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: var(--radius);
    }
    
    .modal-xl-custom {
        max-width: 900px;
    }
    
    .image-preview {
        max-width: 200px;
        max-height: 200px;
        margin: 10px 0;
    }
    
    .stock-low {
        color: #dc3545;
        font-weight: 500;
    }
    
    .stock-good {
        color: #198754;
        font-weight: 500;
    }
</style>

<div class="dashboard-content">
    <!-- En-tête de la boutique -->
    <div class="shop-header">
        <div class="shop-info">
            <h2 style="color: var(--primary); margin: 0 0 5px 0;">{{ shop.title }}</h2>
            <p class="text-muted mb-1">
                <i class="fas fa-map-marker-alt me-1"></i>{{ shop.localisation }}
            </p>
            <p class="text-muted mb-0">{{ shop.type_shop }}</p>
            
            <!-- Méthodes de paiement -->
            {% if payment_methods %}
            <div class="payment-methods" style="justify-content: flex-start; margin-top: 10px;">
                {% for method in payment_methods %}
                <div class="payment-icon active" title="{{ method.get_payment_method_display }}">
                    {% if method.payment_method == 'om' %}
                    <i class="fas fa-money-bill-wave"></i>
                    {% elif method.payment_method == 'momo' %}
                    <i class="fas fa-mobile-alt"></i>
                    {% elif method.payment_method == 'whatsapp' %}
                    <i class="fab fa-whatsapp"></i>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        
        <div class="shop-status">
            <div class="badge bg-success fs-6">
                <i class="fas fa-circle me-1"></i> En ligne
            </div>
            <p class="text-muted mb-0 mt-1">
                <small>Depuis {{ shop.created_at|date:"d/m/Y" }}</small>
            </p>
            
            <!-- Note de la boutique -->
            <div class="mt-2">
                <div class="star-rating">
                    {% with rating=shop.note|floatformat:0 %}
                    {% for i in "12345" %}
                        {% if forloop.counter <= rating %}
                        <i class="fas fa-star text-warning"></i>
                        {% else %}
                        <i class="far fa-star text-warning"></i>
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                    <small class="text-muted ms-1">({{ shop.note }})</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <i class="fas fa-chart-line fa-2x" style="color: var(--primary);"></i>
            <div class="stat-value" style="color: var(--primary);">
                {{ total_sales|default:0 }} FCFA
            </div>
            <div class="stat-label">Chiffre d'affaires</div>
            <small class="text-muted">Ce mois</small>
        </div>
        
        <div class="stat-card success">
            <i class="fas fa-shopping-cart fa-2x" style="color: var(--success);"></i>
            <div class="stat-value" style="color: var(--success);">{{ total_orders }}</div>
            <div class="stat-label">Commandes</div>
            <small class="text-muted">Ce mois</small>
        </div>
        
        <div class="stat-card warning">
            <i class="fas fa-seedling fa-2x" style="color: var(--warning);"></i>
            <div class="stat-value" style="color: var(--warning);">{{ total_products }}</div>
            <div class="stat-label">Produits</div>
            <small class="text-muted">En catalogue</small>
        </div>
        
        <div class="stat-card info">
            <i class="fas fa-star fa-2x" style="color: var(--accent);"></i>
            <div class="stat-value" style="color: var(--accent);">{{ average_rating|default:"0.0" }}</div>
            <div class="stat-label">Note moyenne</div>
            <small class="text-muted">Sur 5</small>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="quick-actions">
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#addProductModal">
            <i class="fas fa-plus-circle fa-2x mb-2"></i><br>
            Nouveau produit
        </button>
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#manageShopModal">
            <i class="fas fa-edit fa-2x mb-2"></i><br>
            Gérer boutique
        </button>
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#viewOrdersModal">
            <i class="fas fa-shopping-cart fa-2x mb-2"></i><br>
            Voir commandes
        </button>
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#statisticsModal">
            <i class="fas fa-chart-bar fa-2x mb-2"></i><br>
            Statistiques
        </button>
    </div>

    <!-- Produits récents -->
    <div class="recent-orders mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="color: var(--primary); margin: 0;">
                <i class="fas fa-seedling"></i> Produits récents
            </h4>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewProductsModal">
                Voir tous
            </button>
        </div>
        
        <div class="row">
            {% for product in recent_products %}
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card h-100">
                    {% if product.images.first %}
                    <img src="{{ product.images.first.image.url }}" class="card-img-top" alt="{{ product.name }}" style="height: 120px; object-fit: cover;">
                    {% else %}
                    <div class="card-img-top d-flex align-items-center justify-content-center" style="height: 120px; background: #f8f9fa;">
                        <i class="fas fa-seedling fa-2x text-muted"></i>
                    </div>
                    {% endif %}
                    <div class="card-body">
                        <h6 class="card-title">{{ product.name }}</h6>
                        <p class="card-text text-success fw-bold mb-1">{{ product.price }} FCFA</p>
                        <p class="card-text mb-1">
                            <small class="{% if product.is_low_stock %}stock-low{% else %}stock-good{% endif %}">
                                Stock: {{ product.quantity }}
                            </small>
                        </p>
                        {% if product.is_low_stock %}
                        <p class="card-text mb-1">
                            <small class="stock-low">
                                <i class="fas fa-exclamation-triangle"></i> Stock faible
                            </small>
                        </p>
                        {% endif %}
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge {% if product.quantity > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ product.quantity|yesno:"Disponible,En rupture" }}
                            </span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editProductModal"
                                        data-product-id="{{ product.id }}"
                                        onclick="loadProductData({{ product.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-4">
                <i class="fas fa-seedling fa-3x text-muted mb-3"></i>
                <p class="text-muted">Aucun produit pour le moment</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                    <i class="fas fa-plus"></i> Ajouter votre premier produit
                </button>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Commandes en attente -->
    <div class="recent-orders mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="color: var(--primary); margin: 0;">
                <i class="fas fa-clock"></i> Commandes en attente
            </h4>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewOrdersModal">
                Voir toutes
            </button>
        </div>
        
        {% for order in pending_orders %}
        <div class="order-item">
            <div class="order-info">
                <h6 style="margin: 0; color: var(--dark);">Commande #{{ order.id|stringformat:".8s" }}</h6>
                <small class="text-muted">
                    {{ order.customer_first_name }} {{ order.customer_last_name }} • 
                    {{ order.created_at|date:"d/m/Y H:i" }}
                </small>
                <div class="mt-1">
                    {% for item in order.cart_items %}
                    <small class="text-muted">
                        {{ item.name }} (x{{ item.quantity }}) - {{ item.price }} FCFA
                    </small><br>
                    {% endfor %}
                </div>
            </div>
            <div class="order-status">
                <span class="badge bg-warning">{{ order.get_status_display }}</span>
            </div>
            <div class="order-amount">
                <strong>{{ order.final_amount }} FCFA</strong>
            </div>
            <div class="order-actions">
                <button class="btn btn-sm btn-success" 
                        data-bs-toggle="modal" 
                        data-bs-target="#processOrderModal"
                        data-order-id="{{ order.id }}"
                        onclick="loadOrderData('{{ order.id }}')">
                    Traiter
                </button>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <p class="text-muted">Aucune commande en attente</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Ajout Produit -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl-custom">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addProductModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Ajouter un nouveau produit
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addProductForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">Nom du produit *</label>
                                <input type="text" class="form-control" id="productName" name="name" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">Catégorie *</label>
                                <select class="form-select" id="productCategory" name="category" required>
                                    <option value="">Sélectionnez une catégorie</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="productPrice" class="form-label">Prix (FCFA) *</label>
                                <input type="number" class="form-control" id="productPrice" name="price" step="0.01" min="0" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="productQuantity" class="form-label">Quantité en stock *</label>
                                <input type="number" class="form-control" id="productQuantity" name="quantity" min="0" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productExpiry" class="form-label">Date de péremption (optionnel)</label>
                                <input type="date" class="form-control" id="productExpiry" name="expiry_date">
                            </div>
                            
                            <div class="mb-3">
                                <label for="productDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="productDescription" name="description" rows="4"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="productImages" class="form-label">Images du produit</label>
                                <input type="file" class="form-control" id="productImages" name="images" multiple accept="image/*">
                                <div class="form-text">Vous pouvez sélectionner plusieurs images</div>
                            </div>
                            
                            <div id="imagePreview" class="mb-3"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Enregistrer le produit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Édition Produit -->
<div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl-custom">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editProductModalLabel">
                    <i class="fas fa-edit me-2"></i>Modifier le produit
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editProductForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div id="editProductContent">
                        <!-- Contenu chargé dynamiquement -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>Mettre à jour
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Gestion Boutique -->
<div class="modal fade" id="manageShopModal" tabindex="-1" aria-labelledby="manageShopModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="manageShopModalLabel">
                    <i class="fas fa-store me-2"></i>Gérer ma boutique
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <i class="fas fa-info-circle fa-3x text-info mb-3"></i>
                                <h5>Informations boutique</h5>
                                <p class="text-muted">Modifier les informations de base</p>
                                <button class="btn btn-outline-info" onclick="editShopInfo()">
                                    <i class="fas fa-edit me-1"></i>Modifier
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-body text-center">
                                <i class="fas fa-credit-card fa-3x text-success mb-3"></i>
                                <h5>Méthodes de paiement</h5>
                                <p class="text-muted">Gérer les moyens de paiement</p>
                                <button class="btn btn-outline-success" onclick="managePaymentMethods()">
                                    <i class="fas fa-cog me-1"></i>Configurer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Voir Commandes -->
 {% comment %} <div class="modal fade" id="viewOrdersModal" tabindex="-1" aria-labelledby="viewOrdersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="viewOrdersModalLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Toutes les commandes
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="ordersListContent">
                    <!-- Liste des commandes chargée dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>  {% endcomment %}

<!-- Modal Traiter Commande -->
<div class="modal fade" id="processOrderModal" tabindex="-1" aria-labelledby="processOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="processOrderModalLabel">
                    <i class="fas fa-cog me-2"></i>Traiter la commande
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="processOrderContent">
                    <!-- Détails de la commande chargés dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Voir Produits -->
 {% comment %} <div class="modal fade" id="viewProductsModal" tabindex="-1" aria-labelledby="viewProductsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewProductsModalLabel">
                    <i class="fas fa-seedling me-2"></i>Tous les produits
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="productsListContent">
                    <!-- Liste des produits chargée dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>  {% endcomment %}

<!-- Modal Statistiques -->
 {% comment %} <div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="statisticsModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>Statistiques détaillées
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="statisticsContent">
                    <!-- Statistiques détaillées chargées dynamiquement -->
                </div>
            </div>
        </div>
    </div>
</div>  {% endcomment %}

<!-- Modal Tous les Produits (contenu pré-chargé) -->
 <div class="modal fade" id="viewProductsModal" tabindex="-1" aria-labelledby="viewProductsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewProductsModalLabel">
                    <i class="fas fa-seedling me-2"></i>Tous les produits ({{ all_products.count }})
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Nom</th>
                                <th>Catégorie</th>
                                <th>Prix</th>
                                <th>Stock</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in all_products %}
                            <tr>
                                <td>
                                    {% if product.images.first %}
                                    <img src="{{ product.images.first.image.url }}" 
                                         alt="{{ product.name }}"
                                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                                    {% else %}
                                    <div style="width: 50px; height: 50px; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-seedling text-muted"></i>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>{{ product.name }}</td>
                                <td>{{ product.category.name }}</td>
                                <td class="fw-bold text-success">{{ product.price }} FCFA</td>
                                <td>
                                    <span class="{% if product.is_low_stock %}stock-low{% else %}stock-good{% endif %}">
                                        {{ product.quantity }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if product.quantity > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ product.quantity|yesno:"Disponible,Rupture" }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-warning" 
                                            onclick="loadProductData({{ product.id }})"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editProductModal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="fas fa-seedling fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Aucun produit trouvé</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Toutes les Commandes (contenu pré-chargé) -->
<div class="modal fade" id="viewOrdersModal" tabindex="-1" aria-labelledby="viewOrdersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="viewOrdersModalLabel">
                    <i class="fas fa-shopping-cart me-2"></i>Toutes les commandes ({{ all_orders.count }})
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Client</th>
                                <th>Date</th>
                                <th>Montant</th>
                                <th>Méthode</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in all_orders %}
                            <tr>
                                <td><small>#{{ order.id|stringformat:".8s" }}</small></td>
                                <td>{{ order.customer_first_name }} {{ order.customer_last_name }}</td>
                                <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>
                                <td class="fw-bold">{{ order.final_amount }} FCFA</td>
                                <td>
                                    <span class="badge bg-info">
                                        {{ order.get_payment_method_display }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if order.status == 'paid' %}bg-success
                                        {% elif order.status == 'pending' %}bg-warning
                                        {% elif order.status == 'failed' %}bg-danger
                                        {% else %}bg-secondary{% endif %}">
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info"
                                            onclick="loadOrderData('{{ order.id }}')"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#processOrderModal">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Aucune commande trouvée</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Statistiques (contenu pré-chargé) -->
<div class="modal fade" id="statisticsModal" tabindex="-1" aria-labelledby="statisticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="statisticsModalLabel">
                    <i class="fas fa-chart-bar me-2"></i>Statistiques détaillées
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Statistiques par statut de commande -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">Commandes par statut</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    {% for stat in orders_by_status %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ stat.status|title }}
                                        <span class="badge bg-primary rounded-pill">
                                            {{ stat.count }} ({{ stat.total|default:0 }} FCFA)
                                        </span>
                                    </li>
                                    {% empty %}
                                    <li class="list-group-item text-muted text-center">
                                        Aucune donnée disponible
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Produits en faible stock -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0">Produits en faible stock</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Produit</th>
                                                <th>Stock</th>
                                                <th>Prix</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for product in all_products %}
                                            {% if product.is_low_stock %}
                                            <tr>
                                                <td>{{ product.name }}</td>
                                                <td class="stock-low">{{ product.quantity }}</td>
                                                <td>{{ product.price }} FCFA</td>
                                            </tr>
                                            {% endif %}
                                            {% empty %}
                                            <tr>
                                                <td colspan="3" class="text-center text-muted">
                                                    Aucun produit en faible stock
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top produits -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Top produits</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for product in top_products %}
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100">
                                            {% if product.images.first %}
                                            <img src="{{ product.images.first.image.url }}" 
                                                 class="card-img-top" 
                                                 alt="{{ product.name }}"
                                                 style="height: 100px; object-fit: cover;">
                                            {% endif %}
                                            <div class="card-body">
                                                <h6 class="card-title">{{ product.name }}</h6>
                                                <p class="card-text text-success fw-bold">
                                                    {{ product.price }} FCFA
                                                </p>
                                                <p class="card-text">
                                                    <small>Stock: {{ product.quantity }}</small>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12 text-center py-4">
                                        <p class="text-muted">Aucune donnée de vente disponible</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> 

<script>
// Gestion de l'aperçu des images
document.getElementById('productImages').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    for (let file of e.target.files) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-preview me-2 mb-2';
                preview.appendChild(img);
            }
            reader.readAsDataURL(file);
        }
    }
});
// Dans votre fichier template, ajoutez ces fonctions JavaScript supplémentaires :

// Fonction pour charger les détails de la boutique
async function loadShopDetails(shopId) {
    try {
        const response = await fetch(`/account/api/shop/${shopId}/`);
        if (!response.ok) throw new Error('Erreur de chargement');
        
        const data = await response.json();
        
        // Remplir le formulaire d'édition de boutique
        // (À implémenter selon votre interface)
        console.log('Données boutique:', data);
        
        return data;
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('danger', 'Erreur lors du chargement des données de la boutique');
        return null;
    }
}

// Fonction pour mettre à jour un produit (version améliorée)
async function updateProduct(event, productId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Ajouter les images marquées pour suppression
    const deletedImages = [];
    document.querySelectorAll('[data-image-delete="true"]').forEach(img => {
        const imgId = img.dataset.imageId;
        if (imgId) deletedImages.push(imgId);
    });
    
    if (deletedImages.length > 0) {
        formData.append('deleted_images', deletedImages.join(','));
    }
    
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    try {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Mise à jour...';
        
        const response = await fetch(`/account/api/products/${productId}/update/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', data.message || 'Produit mis à jour avec succès');
            
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                if (modal) modal.hide();
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error || data.errors?.join(', ') || 'Erreur lors de la mise à jour');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('danger', 'Erreur réseau lors de la mise à jour');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
}

// Fonction pour marquer une image à supprimer
function markImageForDeletion(imageId, button) {
    if (confirm('Supprimer cette image ?')) {
        const imgElement = button.parentElement.querySelector('img');
        if (imgElement) {
            imgElement.style.opacity = '0.3';
            imgElement.style.filter = 'grayscale(100%)';
            imgElement.dataset.imageDelete = 'true';
            imgElement.dataset.imageId = imageId;
            
            button.innerHTML = '<i class="fas fa-undo"></i>';
            button.classList.remove('btn-danger');
            button.classList.add('btn-warning');
            button.onclick = () => unmarkImageForDeletion(imageId, button);
        }
    }
}

// Fonction pour annuler la suppression d'une image
function unmarkImageForDeletion(imageId, button) {
    const imgElement = button.parentElement.querySelector('img');
    if (imgElement) {
        imgElement.style.opacity = '1';
        imgElement.style.filter = 'none';
        delete imgElement.dataset.imageDelete;
        delete imgElement.dataset.imageId;
        
        button.innerHTML = '<i class="fas fa-trash"></i>';
        button.classList.remove('btn-warning');
        button.classList.add('btn-danger');
        button.onclick = () => markImageForDeletion(imageId, button);
    }
}

// Chargement des données du produit pour édition
function loadProductData(productId) {
    fetch(`/account/api/products/${productId}/`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="editProductName" class="form-label">Nom du produit</label>
                            <input type="text" class="form-control" id="editProductName" name="name" value="${data.name}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductCategory" class="form-label">Catégorie</label>
                            <select class="form-select" id="editProductCategory" name="category" required>
                                {% for category in categories %}
                                <option value="{{ category.id }}" ${data.category == {{ category.id }} ? 'selected' : ''}>{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductPrice" class="form-label">Prix (FCFA)</label>
                            <input type="number" class="form-control" id="editProductPrice" name="price" value="${data.price}" step="0.01" min="0" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductQuantity" class="form-label">Quantité en stock</label>
                            <input type="number" class="form-control" id="editProductQuantity" name="quantity" value="${data.quantity}" min="0" required>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="editProductExpiry" class="form-label">Date de péremption</label>
                            <input type="date" class="form-control" id="editProductExpiry" name="expiry_date" value="${data.expiry_date || ''}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editProductDescription" name="description" rows="4">${data.description || ''}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editProductImages" class="form-label">Nouvelles images</label>
                            <input type="file" class="form-control" id="editProductImages" name="images" multiple accept="image/*">
                        </div>
                        
                        <div class="current-images">
                            <h6>Images actuelles:</h6>
                            ${data.images ? data.images.map(img => 
                                `<img src="${img.image}" class="image-preview me-2 mb-2" alt="${img.alt_text || 'Product image'}">`
                            ).join('') : 'Aucune image'}
                        </div>
                    </div>
                </div>
                <input type="hidden" name="product_id" value="${productId}">
            `;
            document.getElementById('editProductContent').innerHTML = content;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('editProductContent').innerHTML = '<div class="alert alert-danger">Erreur lors du chargement des données</div>';
        });
}

// Chargement des données de commande
function loadOrderData(orderId) {
    fetch(`/account/api/orders/${orderId}/`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <div class="order-details">
                    <h5>Détails de la commande #${orderId}</h5>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Client:</strong> ${data.customer_first_name} ${data.customer_last_name}<br>
                            <strong>Email:</strong> ${data.customer_email}<br>
                            <strong>Téléphone:</strong> ${data.customer_phone}
                        </div>
                        <div class="col-md-6">
                            <strong>Méthode de paiement:</strong> ${data.payment_method}<br>
                            <strong>Statut:</strong> <span class="badge bg-warning">${data.status_display}</span><br>
                            <strong>Total:</strong> ${data.final_amount} FCFA
                        </div>
                    </div>
                    
                    <h6>Articles commandés:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Produit</th>
                                    <th>Quantité</th>
                                    <th>Prix</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.cart_items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>${item.price} FCFA</td>
                                        <td>${item.price * item.quantity} FCFA</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <label for="orderStatus" class="form-label">Changer le statut:</label>
                        <select class="form-select" id="orderStatus">
                            <option value="paid" ${data.status === 'paid' ? 'selected' : ''}>Payé</option>
                            <option value="payment_verified" ${data.status === 'payment_verified' ? 'selected' : ''}>Paiement vérifié</option>
                            <option value="failed" ${data.status === 'failed' ? 'selected' : ''}>Échec</option>
                            <option value="refunded" ${data.status === 'refunded' ? 'selected' : ''}>Remboursé</option>
                        </select>
                    </div>
                </div>
            `;
            document.getElementById('processOrderContent').innerHTML = content;
        });
}

// Gestion de la soumission du formulaire d'ajout de produit
document.getElementById('addProductForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "create_product_api" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fermer le modal et recharger la page
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            location.reload();
        } else {
            alert('Erreur: ' + (data.error || 'Erreur lors de l\'ajout du produit'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erreur lors de l\'ajout du produit');
    });
});

// Fonction utilitaire pour récupérer le token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fonctions placeholder pour les autres modales
function editShopInfo() {
    alert('Fonctionnalité de modification boutique à implémenter');
}

function managePaymentMethods() {
    alert('Fonctionnalité de gestion des paiements à implémenter');
}
</script>
<script>
// Fonction pour charger les données du produit
async function loadProductData(productId) {
    try {
        const response = await fetch(`/account/api/products/${productId}/`);
        if (!response.ok) throw new Error('Erreur de chargement');
        
        const data = await response.json();
        
        // Construire le formulaire d'édition
        const editProductContent = document.getElementById('editProductContent');
        
        // Préparer les options de catégorie
        let categoryOptions = '';
        {% for category in categories %}
        categoryOptions += `
            <option value="{{ category.id }}" ${data.category == {{ category.id }} ? 'selected' : ''}>
                {{ category.name }}
            </option>`;
        {% endfor %}
        
        // Afficher les images existantes
        let currentImages = '<p class="text-muted">Aucune image</p>';
        if (data.images && data.images.length > 0) {
            currentImages = data.images.map(img => 
                `<div class="d-inline-block me-2 mb-2">
                    <img src="${img.image}" class="image-preview" alt="${img.alt_text}" style="max-width: 100px;">
                    <button type="button" class="btn btn-sm btn-danger btn-sm mt-1" onclick="deleteProductImage(${img.id}, this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>`
            ).join('');
        }
        
        editProductContent.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="editProductName" class="form-label">Nom du produit *</label>
                        <input type="text" class="form-control" id="editProductName" 
                               name="name" value="${data.name || ''}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductCategory" class="form-label">Catégorie *</label>
                        <select class="form-select" id="editProductCategory" name="category" required>
                            <option value="">Sélectionnez une catégorie</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductPrice" class="form-label">Prix (FCFA) *</label>
                        <input type="number" class="form-control" id="editProductPrice" 
                               name="price" value="${data.price || '0'}" step="0.01" min="0" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductQuantity" class="form-label">Quantité en stock *</label>
                        <input type="number" class="form-control" id="editProductQuantity" 
                               name="quantity" value="${data.quantity || '0'}" min="0" required>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="editProductExpiry" class="form-label">Date de péremption</label>
                        <input type="date" class="form-control" id="editProductExpiry" 
                               name="expiry_date" value="${data.expiry_date || ''}">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editProductDescription" 
                                  name="description" rows="4">${data.description || ''}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editProductImages" class="form-label">Nouvelles images</label>
                        <input type="file" class="form-control" id="editProductImages" 
                               name="images" multiple accept="image/*">
                        <div class="form-text">Ajoutez de nouvelles images (optionnel)</div>
                    </div>
                    
                    <div class="current-images mb-3">
                        <label class="form-label">Images actuelles:</label>
                        <div id="currentImagesContainer" class="mt-2">
                            ${currentImages}
                        </div>
                    </div>
                </div>
            </div>
            <input type="hidden" name="product_id" value="${productId}">
        `;
        
        // Gérer l'aperçu des nouvelles images
        document.getElementById('editProductImages').addEventListener('change', function(e) {
            const previewContainer = document.createElement('div');
            previewContainer.className = 'new-images-preview mt-2';
            previewContainer.innerHTML = '<p class="text-success mb-1"><small>Nouvelles images:</small></p>';
            
            for (let file of e.target.files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'image-preview me-2 mb-2';
                        img.style.maxWidth = '80px';
                        previewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
            
            editProductContent.querySelector('.current-images').appendChild(previewContainer);
        });
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('editProductContent').innerHTML = 
            '<div class="alert alert-danger">Erreur lors du chargement des données du produit</div>';
    }
}

// Fonction pour charger les données de commande
async function loadOrderData(orderId) {
    try {
        const response = await fetch(`/account/api/orders/${orderId}/`);
        if (!response.ok) throw new Error('Erreur de chargement');
        
        const data = await response.json();
        
        // Construire le HTML pour traiter la commande
        const processOrderContent = document.getElementById('processOrderContent');
        
        // Calculer le total des articles
        let cartTotal = 0;
        let cartItemsHtml = '';
        
        if (data.cart_items && Array.isArray(data.cart_items)) {
            data.cart_items.forEach(item => {
                const itemTotal = (item.price || 0) * (item.quantity || 1);
                cartTotal += itemTotal;
                cartItemsHtml += `
                    <tr>
                        <td>${item.name || 'Produit'}</td>
                        <td>${item.quantity || 1}</td>
                        <td>${item.price || 0} FCFA</td>
                        <td>${itemTotal} FCFA</td>
                    </tr>
                `;
            });
        }
        
        // Options de statut
        const statusOptions = [
            ['pending', 'En attente'],
            ['waiting_payment', 'En attente de paiement'],
            ['payment_verified', 'Paiement vérifié'],
            ['paid', 'Payé'],
            ['failed', 'Échec'],
            ['refunded', 'Remboursé']
        ];
        
        let statusSelect = '';
        statusOptions.forEach(([value, label]) => {
            statusSelect += `<option value="${value}" ${data.status === value ? 'selected' : ''}>${label}</option>`;
        });
        
        processOrderContent.innerHTML = `
            <div class="order-details">
                <h5>Commande #${data.id.substring(0, 8)}</h5>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Vous pouvez mettre à jour le statut de cette commande
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-user me-2"></i>Informations client</h6>
                                <p class="mb-1"><strong>Nom:</strong> ${data.customer_first_name} ${data.customer_last_name}</p>
                                <p class="mb-1"><strong>Email:</strong> ${data.customer_email}</p>
                                <p class="mb-0"><strong>Téléphone:</strong> ${data.customer_phone}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title"><i class="fas fa-receipt me-2"></i>Détails de la commande</h6>
                                <p class="mb-1"><strong>Date:</strong> ${data.created_at}</p>
                                <p class="mb-1"><strong>Méthode de paiement:</strong> ${data.payment_method}</p>
                                <p class="mb-1"><strong>Statut actuel:</strong> 
                                    <span class="badge bg-${data.status === 'paid' ? 'success' : data.status === 'pending' ? 'warning' : 'secondary'}">
                                        ${data.status_display}
                                    </span>
                                </p>
                                <p class="mb-0"><strong>Paiement vérifié:</strong> 
                                    ${data.payment_verified ? '✅ Oui' : '❌ Non'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <h6>Articles commandés:</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Produit</th>
                                <th>Quantité</th>
                                <th>Prix unitaire</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cartItemsHtml}
                        </tbody>
                        <tfoot>
                            <tr class="table-active">
                                <td colspan="3" class="text-end"><strong>Total commande:</strong></td>
                                <td><strong>${data.final_amount || cartTotal} FCFA</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <form id="updateOrderForm" onsubmit="updateOrderStatus(event, '${orderId}')">
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <label for="orderStatus" class="form-label">Changer le statut:</label>
                            <select class="form-select" id="orderStatus" name="status" required>
                                ${statusSelect}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="fas fa-save me-1"></i>Mettre à jour
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <textarea class="form-control" name="notes" 
                                  placeholder="Notes additionnelles (optionnel)" rows="2"></textarea>
                    </div>
                </form>
            </div>
        `;
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('processOrderContent').innerHTML = 
            '<div class="alert alert-danger">Erreur lors du chargement des données de la commande</div>';
    }
}

// Fonction pour mettre à jour le statut d'une commande
async function updateOrderStatus(event, orderId) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    
    try {
        const response = await fetch(`/account/api/orders/${orderId}/update/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', 'Statut mis à jour avec succès');
            
            // Fermer le modal après 1.5 secondes
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('processOrderModal'));
                if (modal) modal.hide();
                
                // Recharger la page pour voir les changements
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error || 'Erreur lors de la mise à jour');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('danger', 'Erreur réseau');
    }
}

// Fonction pour gérer l'aperçu des images dans l'ajout de produit
document.getElementById('productImages').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '<p class="text-success mb-1"><small>Aperçu des images:</small></p>';
    
    for (let file of e.target.files) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'image-preview me-2 mb-2';
                img.style.maxWidth = '100px';
                preview.appendChild(img);
            }
            reader.readAsDataURL(file);
        }
    }
});

// Gestion de la soumission du formulaire d'ajout de produit
document.getElementById('addProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    try {
        // Désactiver le bouton pendant l'envoi
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enregistrement...';
        
        const response = await fetch('/account/api/products/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('success', 'Produit ajouté avec succès!');
            
            // Fermer le modal après 1.5 secondes
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
                if (modal) modal.hide();
                
                // Recharger la page pour voir le nouveau produit
                location.reload();
            }, 1500);
        } else {
            showAlert('danger', data.error || 'Erreur lors de l\'ajout du produit');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('danger', 'Erreur réseau lors de l\'ajout du produit');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Fonction pour supprimer une image de produit
async function deleteProductImage(imageId, button) {
    if (!confirm('Supprimer cette image ?')) return;
    
    try {
        const response = await fetch(`/account/api/product-images/${imageId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            // Supprimer l'élément visuellement
            button.parentElement.remove();
            showAlert('success', 'Image supprimée avec succès');
        } else {
            showAlert('danger', 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('danger', 'Erreur réseau');
    }
}

// Fonctions utilitaires
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Ajouter en haut de la page
    const container = document.querySelector('.dashboard-content');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss après 5 secondes
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// Fonctions placeholder pour les autres modales
function editShopInfo() {
    window.location.href = "{% url 'marketplace_list' %}";
}

function managePaymentMethods() {
    window.location.href = "{% url 'marketplace_list' %}";
}
</script>
{% endblock %}